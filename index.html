<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœæ£‹æ˜Ÿçƒ (Chiikawa Planet)</title>
    
    <!-- è‡ªå‹•åŠ å…¥ Favicon (å…§åµŒ SVGï¼Œç„¡éœ€å¤–éƒ¨æª”æ¡ˆ) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%23f3dcb0%22/><circle cx=%2235%22 cy=%2235%22 r=%2220%22 fill=%22black%22/><circle cx=%2265%22 cy=%2265%22 r=%2220%22 fill=%22white%22 stroke=%22black%22 stroke-width=%222%22/></svg>">
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- å¼•å…¥ Babel ç”¨æ–¼è§£æ JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è‡ªå®šç¾©å‹•ç•«æ¨£å¼ -->
    <style>
        /* ç¢ºä¿ App å……æ»¿è¢å¹• */
        body, html {
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }

        @keyframes bounce-short { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-25%); } }
        .animate-bounce-short { animation: bounce-short 0.5s ease-in-out 1; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-20px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-down { animation: fade-in-down 0.5s ease-out; }
        
        @keyframes bloom-fade {
            0% { transform: scale(0); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .animate-bloom-fade { animation: bloom-fade 0.6s ease-out forwards; }

        @keyframes ripple {
            0% { transform: scale(0.8); opacity: 1; border-width: 4px; }
            100% { transform: scale(2); opacity: 0; border-width: 0px; }
        }
        .animate-ripple { animation: ripple 0.8s ease-out forwards; }

        @keyframes particle-out {
            0% { transform: rotate(var(--rot)) translate(0) scale(0); opacity: 1; }
            100% { transform: rotate(var(--rot)) translate(80px) scale(1); opacity: 0; }
        }
        
        @keyframes pop-in {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            60% { transform: scale(1.2) rotate(10deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes spin-slow-reverse {
            from { transform: rotate(360deg); }
            to { transform: rotate(0deg); }
        }
        .animate-spin-slow-reverse { animation: spin-slow-reverse 8s linear infinite; }

        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(200px) rotate(360deg); opacity: 0; }
        }

        /* éš±è— Scrollbar ä½†ä¿æŒåŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#d0f0c0] font-sans select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- å…§å»ºåœ–ç¤º ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Brain = (props) => <IconBase {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></IconBase>;
        const Bot = (props) => <IconBase {...props}><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></IconBase>;

        // --- é…è‰²èˆ‡æ¨£å¼ ---
        const THEME = {
          bg: 'bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50',
          board: 'bg-[#eecfa1]',
          boardBorder: 'border-[#dcbfa3]',
          gridLine: 'bg-black',
          p1: {
            id: 'p1',
            name: 'é»‘æ£‹',
            color: 'bg-black', 
            stoneStyle: 'bg-[radial-gradient(circle_at_30%_30%,_#666_2%,_#1a1a1a_30%,_#000000_100%)] shadow-[1px_2px_3px_rgba(0,0,0,0.6)]',
            text: 'text-slate-900',
            light: 'bg-slate-100', 
          },
          p2: {
            id: 'p2',
            name: 'ç™½æ£‹',
            color: 'bg-white', 
            stoneStyle: 'bg-[radial-gradient(circle_at_30%_30%,_#ffffff_5%,_#f8f8f8_40%,_#dcdcdc_100%)] shadow-[1px_2px_3px_rgba(0,0,0,0.4)]',
            text: 'text-slate-600',
            light: 'bg-white', 
          }
        };

        // --- èƒŒæ™¯æ’åœ–çµ„ä»¶ ---
        const SpaceBackground = () => (
          <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
            <svg className="absolute top-[10%] left-[5%] w-12 h-12 text-yellow-200 opacity-60 animate-pulse" viewBox="0 0 100 100">
              <path d="M50 10 L60 35 L85 35 L65 50 L75 75 L50 60 L25 75 L35 50 L15 35 L40 35 Z" fill="currentColor" />
            </svg>
            <svg className="absolute top-[15%] right-[10%] w-24 h-24 text-pink-200 opacity-50" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="30" fill="currentColor" />
              <ellipse cx="50" cy="50" rx="45" ry="12" fill="none" stroke="#fbcfe8" strokeWidth="6" transform="rotate(-20 50 50)" />
            </svg>
            <svg className="absolute bottom-[20%] left-[10%] w-20 h-20 opacity-40" viewBox="0 0 100 100">
                <path d="M50 10 Q70 40 70 70 L50 60 L30 70 Q30 40 50 10 Z" fill="#93c5fd" />
                <path d="M50 60 L50 80" stroke="#60a5fa" strokeWidth="4" strokeLinecap="round" />
                <circle cx="50" cy="40" r="8" fill="white" opacity="0.8" />
                <path d="M30 70 L20 85 M70 70 L80 85" fill="none" stroke="#93c5fd" strokeWidth="4" strokeLinecap="round" />
            </svg>
            <svg className="absolute top-[40%] right-[5%] w-16 h-16 text-green-200 opacity-40 animate-bounce-slow" viewBox="0 0 100 100">
               <ellipse cx="50" cy="60" rx="40" ry="15" fill="#a7f3d0" />
               <path d="M30 60 Q50 20 70 60" fill="#d1fae5" stroke="#a7f3d0" strokeWidth="2" />
               <circle cx="20" cy="60" r="3" fill="#34d399" />
               <circle cx="50" cy="60" r="3" fill="#34d399" />
               <circle cx="80" cy="60" r="3" fill="#34d399" />
            </svg>
            <div className="absolute top-[60%] left-[20%] w-4 h-4 bg-yellow-100 rounded-full opacity-40"></div>
            <div className="absolute top-[80%] right-[30%] w-6 h-6 bg-purple-200 rounded-full opacity-30"></div>
            <div className="absolute top-[30%] left-[40%] w-3 h-3 bg-blue-100 rounded-full opacity-50"></div>
          </div>
        );

        // --- é›£åº¦è¨­å®š ---
        const DIFFICULTY_LEVELS = [
          { 
            level: 1, 
            label: 'åˆç´š', 
            desc: 'ç°¡å–®', 
            imgSrc: 'https://img2.91mai.com/o2o/image/cc99fb35-c605-4666-9cf7-6058c47f7645.jpg',
            charName: 'å‰ä¼Š',
            slogan: 'ä¸€èµ·åŠ æ²¹ï¼', 
          },
          { 
            level: 2, 
            label: 'ä¸­ç´š', 
            desc: 'æ™®é€š', 
            imgSrc: 'https://img2.91mai.com/o2o/image/65431ff4-7c34-49e3-9240-5d92ace16fab.jpg',
            charName: 'å°å…«',
            slogan: 'æœƒæœ‰è¾¦æ³•çš„ï¼', 
          },
          { 
            level: 3, 
            label: 'é«˜ç´š', 
            desc: 'æŒ‘æˆ°', 
            imgSrc: 'https://img2.91mai.com/o2o/image/60817ea8-a092-4239-a4fe-2eb0a8db4b8e.jpg',
            charName: 'çƒè–©å¥‡',
            slogan: 'æ”¾é¦¬éä¾†ï¼', 
          },
        ];

        const BOARD_OPTIONS = [
            { size: 9, label: '9è·¯ (å…¥é–€)' },
            { size: 13, label: '13è·¯ (é€²éš)' },
            { size: 19, label: '19è·¯ (æ¨™æº–)' },
        ];

        const KOMI = 7.5;

        // --- ç‰¹æ•ˆçµ„ä»¶ ---
        const CaptureEffect = () => (
          <div className="absolute inset-0 pointer-events-none flex items-center justify-center z-50">
            <div className="absolute w-32 h-32 bg-pink-300 rounded-full opacity-0 animate-bloom-fade blur-xl"></div>
            <div className="absolute w-full h-full border-4 border-pink-200 rounded-full opacity-0 animate-ripple"></div>
            <div className="relative w-40 h-40 animate-spin-slow-reverse">
                {[...Array(8)].map((_, i) => (
                    <div 
                        key={i}
                        className="absolute top-1/2 left-1/2 w-4 h-4 bg-pink-400 rounded-full shadow-[0_0_10px_rgba(255,192,203,0.8)]"
                        style={{
                            transform: `rotate(${i * 45}deg) translate(60px) scale(0)`,
                            animation: `particle-out 0.8s ease-out forwards ${i * 0.05}s`
                        }}
                    />
                ))}
            </div>
            <svg viewBox="0 0 100 100" className="w-24 h-24 absolute animate-pop-in">
                <path d="M50 10 L60 35 L85 35 L65 50 L75 75 L50 60 L25 75 L35 50 L15 35 L40 35 Z" fill="#ffe4e6" stroke="#f472b6" strokeWidth="2" />
                <circle cx="50" cy="50" r="15" fill="#fff" opacity="0.8" />
            </svg>
          </div>
        );

        const WinEffect = () => (
          <div className="absolute inset-0 pointer-events-none z-0 overflow-hidden rounded-2xl">
              <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[200%] h-[200%] bg-[conic-gradient(from_0deg,transparent_0deg,#fff7ed_30deg,transparent_60deg,#fff7ed_90deg,transparent_120deg)] animate-spin-slow opacity-50"></div>
              {[...Array(20)].map((_, i) => (
                  <div 
                    key={i}
                    className={`absolute w-2 h-4 rounded-sm ${['bg-pink-300', 'bg-yellow-300', 'bg-blue-300', 'bg-green-300'][i % 4]}`}
                    style={{
                        top: '-20px',
                        left: `${Math.random() * 100}%`,
                        animation: `confetti-fall ${1.5 + Math.random()}s linear infinite`,
                        animationDelay: `${Math.random()}s`
                    }}
                  />
              ))}
          </div>
        );

        // --- æ ¸å¿ƒé‚è¼¯ ---
        const isOnBoard = (x, y, size) => x >= 0 && x < size && y >= 0 && y < size;
        const getStone = (board, x, y) => board[y][x];

        const getGroup = (board, x, y, size) => {
          const color = getStone(board, x, y);
          if (!color) return null;
          const group = [];
          const visited = new Set();
          const queue = [{ x, y }];
          while (queue.length > 0) {
            const { x: cx, y: cy } = queue.pop();
            const key = `${cx},${cy}`;
            if (visited.has(key)) continue;
            visited.add(key);
            group.push({ x: cx, y: cy });
            [[0, 1], [0, -1], [1, 0], [-1, 0]].forEach(([dx, dy]) => {
              const nx = cx + dx, ny = cy + dy;
              if (isOnBoard(nx, ny, size) && getStone(board, nx, ny) === color) queue.push({ x: nx, y: ny });
            });
          }
          return group;
        };

        const countLiberties = (board, group, size) => {
          const liberties = new Set();
          for (const stone of group) {
            [[0, 1], [0, -1], [1, 0], [-1, 0]].forEach(([dx, dy]) => {
              const nx = stone.x + dx, ny = stone.y + dy;
              if (isOnBoard(nx, ny, size) && getStone(board, nx, ny) === null) liberties.add(`${nx},${ny}`);
            });
          }
          return liberties.size;
        };

        const simulateMove = (currentBoard, x, y, color, size) => {
          if (currentBoard[y][x] !== null) return { valid: false };
          const opponent = color === 'p1' ? 'p2' : 'p1';
          const newBoard = currentBoard.map(row => [...row]);
          newBoard[y][x] = color;
          let capturedCount = 0;
          const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
          const capturedGroups = [];
          directions.forEach(([dx, dy]) => {
            const nx = x + dx, ny = y + dy;
            if (isOnBoard(nx, ny, size) && newBoard[ny][nx] === opponent) {
              const group = getGroup(newBoard, nx, ny, size);
              if (group && countLiberties(newBoard, group, size) === 0) capturedGroups.push(group);
            }
          });
          capturedGroups.forEach(group => {
            group.forEach(stone => {
              newBoard[stone.y][stone.x] = null;
              capturedCount++;
            });
          });
          if (capturedCount === 0) {
            const myGroup = getGroup(newBoard, x, y, size);
            if (countLiberties(newBoard, myGroup, size) === 0) return { valid: false, suicide: true };
          }
          return { valid: true, newBoard, capturedCount };
        };

        const calculateScore = (board, size) => {
            let blackStones = 0;
            let whiteStones = 0;
            let blackTerritory = 0;
            let whiteTerritory = 0;
            const territoryMap = Array(size).fill(null).map(() => Array(size).fill(null)); 
            const visited = new Set();
            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const color = board[y][x];
                    if (color === 'p1') blackStones++;
                    else if (color === 'p2') whiteStones++;
                    else {
                        const key = `${x},${y}`;
                        if (visited.has(key)) continue;
                        const emptyGroup = [];
                        const queue = [{ x, y }];
                        visited.add(key);
                        let touchesBlack = false;
                        let touchesWhite = false;
                        while (queue.length > 0) {
                            const { x: cx, y: cy } = queue.pop();
                            emptyGroup.push({ x: cx, y: cy });
                            [[0, 1], [0, -1], [1, 0], [-1, 0]].forEach(([dx, dy]) => {
                                const nx = cx + dx, ny = cy + dy;
                                if (isOnBoard(nx, ny, size)) {
                                    const neighborColor = board[ny][nx];
                                    if (neighborColor === 'p1') touchesBlack = true;
                                    else if (neighborColor === 'p2') touchesWhite = true;
                                    else {
                                        const nKey = `${nx},${ny}`;
                                        if (!visited.has(nKey)) {
                                            visited.add(nKey);
                                            queue.push({ x: nx, y: ny });
                                        }
                                    }
                                }
                            });
                        }
                        if (touchesBlack && !touchesWhite) {
                            blackTerritory += emptyGroup.length;
                            emptyGroup.forEach(p => territoryMap[p.y][p.x] = 'p1');
                        } else if (!touchesBlack && touchesWhite) {
                            whiteTerritory += emptyGroup.length;
                            emptyGroup.forEach(p => territoryMap[p.y][p.x] = 'p2');
                        } else {
                            emptyGroup.forEach(p => territoryMap[p.y][p.x] = 'neutral');
                        }
                    }
                }
            }
            return {
                black: blackStones + blackTerritory,
                white: whiteStones + whiteTerritory + KOMI,
                details: { blackStones, blackTerritory, whiteStones, whiteTerritory, komi: KOMI },
                territoryMap
            };
        };

        const getAiMove = (board, size, aiColor, difficulty) => {
          const validMoves = [];
          const opponent = aiColor === 'p1' ? 'p2' : 'p1';
          for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
              const result = simulateMove(board, x, y, aiColor, size);
              if (result.valid) {
                let score = Math.random() * 10;
                if (difficulty >= 2) {
                  if (result.capturedCount > 0) score += 2000 * result.capturedCount; 
                  
                  const directions = [[0, 1], [0, -1], [1, 0], [-1, 0]];
                  let putsOpponentInAtari = false;
                  directions.forEach(([dx, dy]) => {
                        const nx = x + dx, ny = y + dy;
                        if (isOnBoard(nx, ny, size) && result.newBoard[ny][nx] === opponent) {
                            const group = getGroup(result.newBoard, nx, ny, size);
                            if (group && countLiberties(result.newBoard, group, size) === 1) {
                                putsOpponentInAtari = true;
                            }
                        }
                  });
                  if (putsOpponentInAtari) score += 400;
                }

                if (difficulty >= 3) {
                  if ((x === 2 || x === size - 3) && (y === 2 || y === size - 3)) score += 60;
                  if ((x === size/2 | 0) && (y === size/2 | 0)) score += 30;
                  const myGroup = getGroup(result.newBoard, x, y, size);
                  if (countLiberties(result.newBoard, myGroup, size) <= 1 && result.capturedCount === 0) {
                      score -= 500; 
                  }
                }
                validMoves.push({ x, y, score });
              }
            }
          }
          
          if (difficulty >= 2) {
            for (let y = 0; y < size; y++) {
              for (let x = 0; x < size; x++) {
                if (board[y][x] === null) {
                  const enemyResult = simulateMove(board, x, y, opponent, size);
                  if (enemyResult.valid && enemyResult.capturedCount > 0) {
                     const move = validMoves.find(m => m.x === x && m.y === y);
                     if (move) {
                         move.score += enemyResult.capturedCount * 800; 
                     }
                  }
                }
              }
            }
          }

          if (validMoves.length === 0) return null;
          validMoves.sort((a, b) => b.score - a.score);
          if (difficulty === 1) return validMoves[Math.floor(Math.random() * Math.min(validMoves.length, 8))];
          if (difficulty === 2) {
               if (Math.random() < 0.2) return validMoves[Math.floor(Math.random() * Math.min(validMoves.length, 3))];
               return validMoves[0];
          }
          return validMoves[0];
        };

        // --- App Component ---
        function App() {
          const [gameStatus, setGameStatus] = useState('setup');
          const [playerColor, setPlayerColor] = useState('p1');
          const [difficulty, setDifficulty] = useState(1);
          const [boardSize, setBoardSize] = useState(9);
          const [board, setBoard] = useState([]);
          const [turn, setTurn] = useState('p1');
          const [prisoners, setPrisoners] = useState({ p1: 0, p2: 0 });
          const [lastMove, setLastMove] = useState(null);
          const [message, setMessage] = useState('');
          const [showConfetti, setShowConfetti] = useState(false);
          const [isAiThinking, setIsAiThinking] = useState(false);
          const [finalScore, setFinalScore] = useState(null);
          const [territoryMap, setTerritoryMap] = useState(null);
          const [confirmAction, setConfirmAction] = useState(null);

          const hasMoves = board.length > 0 && board.some(row => row.some(cell => cell !== null));

          const handleSetBoardSize = (size) => {
              setBoardSize(size);
              if (size === 9) {
                  setDifficulty(1);
              } else {
                  if (difficulty === 1) {
                      setDifficulty(2);
                  }
              }
          };
          
          const getBoardSizeStyle = (size) => {
             if (size === 9) return { width: 'min(90vw, 450px)', height: 'min(90vw, 450px)' };
             if (size === 13) return { minWidth: '400px', width: 'max(90vw, 400px)', maxWidth: '70vh', aspectRatio: '1/1' }; 
             if (size === 19) return { minWidth: '640px', width: 'max(90vw, 640px)', maxWidth: '75vh', aspectRatio: '1/1' };
             return {};
          };

          const startGame = () => {
            const size = boardSize;
            setBoard(Array(size).fill(null).map(() => Array(size).fill(null)));
            setTurn('p1'); 
            setPrisoners({ p1: 0, p2: 0 });
            setLastMove(null);
            setFinalScore(null);
            setTerritoryMap(null);
            setShowConfetti(false);
            setGameStatus('playing');
            setMessage('éŠæˆ²é–‹å§‹ï¼è½å­ç„¡æ‚”å–”ï¼');
            setConfirmAction(null); 
          };

          const executeMove = (x, y, isAuto = false) => {
            setShowConfetti(false);
            const result = simulateMove(board, x, y, turn, boardSize);
            if (!result.valid) {
                if (!isAuto && result.suicide) {
                    setMessage('é€™è£¡æ˜¯ç¦è‘—é»(æ²’æœ‰æ°£)ï¼Œä¸èƒ½ä¸‹å–”ï¼');
                    if (navigator.vibrate) navigator.vibrate(200);
                }
                return false;
            }
            setBoard(result.newBoard);
            setLastMove({ x, y });
            if (result.capturedCount > 0) {
              setPrisoners(prev => ({ ...prev, [turn]: prev[turn] + result.capturedCount }));
              const playerText = turn === 'p1' ? 'é»‘æ£‹' : 'ç™½æ£‹';
              setMessage(isAuto ? `AI ${playerText} åƒäº† ${result.capturedCount} å­ï¼` : `å“‡ï¼ä½ æŠ“åˆ°äº† ${result.capturedCount} é¡†æ£‹å­ï¼`);
              setShowConfetti(true);
              setTimeout(() => setShowConfetti(false), 2500);
            } else {
                setMessage(null);
            }
            setTurn(turn === 'p1' ? 'p2' : 'p1');
            return true;
          };

          const handlePlayerMove = (x, y) => {
            if (gameStatus !== 'playing') return;
            if (turn !== playerColor) return;
            if (isAiThinking) return;
            executeMove(x, y);
          };

          useEffect(() => {
            if (gameStatus === 'playing' && turn !== playerColor) {
              setIsAiThinking(true);
              const timer = setTimeout(() => {
                const aiMove = getAiMove(board, boardSize, turn, difficulty);
                if (aiMove) {
                  executeMove(aiMove.x, aiMove.y, true);
                } else {
                  setTurn(turn === 'p1' ? 'p2' : 'p1'); 
                  setMessage('AI é¸æ“‡è™›æ‰‹');
                }
                setIsAiThinking(false);
              }, 800 + Math.random() * 500);
              return () => clearTimeout(timer);
            }
          }, [turn, gameStatus, board]);

          const handleManualEndGame = () => {
            const result = calculateScore(board, boardSize);
            setFinalScore(result);
            setGameStatus('ended');
            setShowConfetti(false); 
            setMessage(`çµç®—å®Œæˆï¼${result.black > result.white ? 'é»‘æ£‹' : 'ç™½æ£‹'}ç²å‹ï¼`);
          };

          const onLeaveRequest = () => {
            setConfirmAction({ type: 'leave', title: 'ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ', desc: 'é€™ç›¤æ£‹é‚„æ²’ä¸‹å®Œå–”ï¼' });
          };

          const onRestartRequest = () => {
            setConfirmAction({ type: 'restart', title: 'ç¢ºå®šè¦é‡ä¾†å—ï¼Ÿ', desc: 'ç¾åœ¨çš„æ£‹å±€æœƒæ¶ˆå¤±å–”ï¼' });
          };

          const onConfirm = () => {
            if (confirmAction.type === 'leave') {
              setGameStatus('setup');
            } else if (confirmAction.type === 'restart') {
              startGame();
            }
            setConfirmAction(null);
          };

          const onCancel = () => setConfirmAction(null);

          // GridLines Component
          const GridLines = ({ size }) => {
            const margin = 50 / size; 
            const lineLength = 100 - (100 / size); 
            return (
                <div className="absolute inset-[4%] pointer-events-none z-0">
                    <div className="absolute border-2 border-black" style={{ top: `calc(${margin}% - 1px)`, left: `calc(${margin}% - 1px)`, width: `calc(${lineLength}% + 2px)`, height: `calc(${lineLength}% + 2px)`, boxSizing: 'border-box' }} />
                    {Array.from({ length: size }).map((_, i) => {
                        if (i === 0 || i === size - 1) return null; 
                        return <div key={`h-${i}`} className="absolute h-[1px] md:h-[1.5px] bg-black" style={{ top: `calc(${((i + 0.5) / size) * 100}% - 0.5px)`, left: `${margin}%`, width: `${lineLength}%` }} />;
                    })}
                    {Array.from({ length: size }).map((_, i) => {
                        if (i === 0 || i === size - 1) return null; 
                        return <div key={`v-${i}`} className="absolute w-[1px] md:w-[1.5px] bg-black" style={{ left: `calc(${((i + 0.5) / size) * 100}% - 0.5px)`, top: `${margin}%`, height: `${lineLength}%` }} />;
                    })}
                </div>
            );
          };

          // StarPoints Component
          const StarPoints = ({ size }) => {
            let points = [];
            if (size === 9) points = [[2, 2], [6, 2], [4, 4], [2, 6], [6, 6]];
            else if (size === 13) points = [[3, 3], [9, 3], [6, 6], [3, 9], [9, 9]];
            else if (size === 19) points = [[3, 3], [9, 3], [15, 3], [3, 9], [9, 9], [15, 9], [3, 15], [9, 15], [15, 15]];
            return (
                <div className="absolute inset-[4%] pointer-events-none z-0">
                     {points.map(([x, y], i) => (
                        <div key={i} className="absolute w-1.5 h-1.5 md:w-2 md:h-2 bg-black rounded-full transform -translate-x-1/2 -translate-y-1/2" style={{ left: `${((x + 0.5) / size) * 100}%`, top: `${((y + 0.5) / size) * 100}%` }} />
                    ))}
                </div>
            );
          };

          // ActionButton Component
          const ActionButton = ({ onClick, label, color, disabled }) => (
            <button onClick={onClick} disabled={disabled} className={`flex items-center justify-center h-14 md:h-16 rounded-2xl transition-all duration-200 px-2 ${disabled ? 'opacity-40 cursor-not-allowed bg-slate-300' : `${color} active:translate-y-1 active:shadow-none hover:-translate-y-0.5`}`}>
              <span className="text-base md:text-lg font-black tracking-wider whitespace-nowrap">{label}</span>
            </button>
          );

          // PlayerCard Component
          const PlayerCard = ({ player, isActive, prisoners, isAi, thinking, score, aiImg }) => {
            const info = THEME[player];
            return (
              <div className={`flex-1 rounded-2xl p-2 md:p-3 flex flex-col items-center transition-all duration-300 border-2 relative overflow-hidden ${isActive ? `scale-105 shadow-lg ${info.border} ${info.light}` : 'border-transparent bg-white/50 scale-100 grayscale-[0.3]'}`}>
                {isAi && <div className="absolute top-0 right-0 bg-slate-600 text-white text-[9px] px-1.5 py-0.5 rounded-bl-lg font-bold">AI</div>}
                {!isAi && <div className="absolute top-0 right-0 bg-pink-400 text-white text-[9px] px-1.5 py-0.5 rounded-bl-lg font-bold">YOU</div>}
                <div className={`w-12 h-12 md:w-14 md:h-14 rounded-full mb-1 flex items-center justify-center text-lg shadow-sm border-0 relative overflow-hidden bg-white ${thinking ? 'animate-pulse' : ''}`}>
                   <div className={`w-full h-full rounded-full ${info.stoneStyle}`}></div>
                   {isAi && <Bot size={20} className={`absolute z-10 ${player === 'p1' ? 'text-white/50' : 'text-slate-800/50'}`} />}
                </div>
                <div className="text-slate-700 font-bold mb-1 text-xs">{info.name}</div>
                {score !== undefined ? (
                    <div className="text-xl font-black text-slate-800">{score}</div>
                ) : (
                    <div className="bg-white/60 px-2 py-0.5 rounded-lg flex items-center gap-1 text-xs font-bold text-slate-500">
                      <Trophy size={12} className="text-yellow-500" />
                      {prisoners}
                    </div>
                )}
              </div>
            );
          };

          // Render Setup Screen
          if (gameStatus === 'setup') {
            return (
              <div className={`h-[100dvh] w-full ${THEME.bg} font-sans flex flex-col items-center justify-center p-4 relative overflow-hidden`}>
                <SpaceBackground />
                <div className="bg-white/90 p-6 md:p-8 rounded-3xl shadow-xl max-w-md w-full animate-fade-in-down border-4 border-blue-100 overflow-y-auto max-h-[90vh] relative z-10">
                    <h1 className="text-3xl font-black text-slate-700 text-center mb-6 flex items-center justify-center">
                        <span className="text-blue-400">åœæ£‹</span><span className="text-pink-400">æ˜Ÿçƒ</span>
                    </h1>

                    <div className="mb-5">
                        <label className="block text-slate-500 font-bold mb-2 text-md">é¸æ“‡é¡è‰²</label>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={() => setPlayerColor('p1')} className={`p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${playerColor === 'p1' ? 'bg-slate-800 text-white border-slate-800 ring-2 ring-offset-2 ring-slate-400' : 'bg-white text-slate-500 border-slate-200'}`}>
                                <div className="w-6 h-6 rounded-full bg-black shadow-sm bg-[radial-gradient(circle_at_35%_35%,_#666_0%,_#000_100%)]"></div>
                                <span className="font-bold text-sm">é»‘æ£‹ (å…ˆæ‰‹)</span>
                            </button>
                            <button onClick={() => setPlayerColor('p2')} className={`p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition-all ${playerColor === 'p2' ? 'bg-white text-slate-800 border-slate-300 ring-2 ring-offset-2 ring-slate-300' : 'bg-slate-50 text-slate-500 border-slate-200'}`}>
                                 <div className="w-6 h-6 rounded-full bg-white border border-slate-300 shadow-sm bg-[radial-gradient(circle_at_35%_35%,_#fff_0%,_#ccc_100%)]"></div>
                                 <span className="font-bold text-sm">ç™½æ£‹ (å¾Œæ‰‹)</span>
                            </button>
                        </div>
                    </div>

                    <div className="mb-5">
                        <label className="block text-slate-500 font-bold mb-2 text-md">æ£‹ç›¤å¤§å°</label>
                        <div className="grid grid-cols-3 gap-2">
                            {BOARD_OPTIONS.map((opt) => (
                                <button key={opt.size} onClick={() => handleSetBoardSize(opt.size)} className={`py-2 px-1 rounded-lg border-2 text-sm font-bold transition-all ${boardSize === opt.size ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-white border-slate-200 text-slate-400'}`}>
                                    {opt.size}è·¯
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="mb-6">
                        <label className="block text-slate-500 font-bold mb-2 text-md">å°æ‰‹ç­‰ç´š</label>
                        <div className="space-y-2">
                            {DIFFICULTY_LEVELS.map((lvl) => {
                                let isDisabled = false;
                                let hintText = "";
                                if (boardSize === 9) {
                                    if (lvl.level > 1) { isDisabled = true; hintText = "éœ€é¸æ“‡13è·¯æˆ–19è·¯è§£é–"; }
                                } else {
                                    if (lvl.level === 1) { isDisabled = true; hintText = "å¤§æ£‹ç›¤ä¸é©åˆåˆç´šå°æ‰‹"; }
                                }
                                return (
                                    <button key={lvl.level} onClick={() => !isDisabled && setDifficulty(lvl.level)} disabled={isDisabled} className={`w-full p-3 rounded-xl border-2 text-left transition-all flex items-center gap-3 ${isDisabled ? 'opacity-50 cursor-not-allowed bg-slate-100 border-slate-100 grayscale' : difficulty === lvl.level ? 'border-pink-400 bg-pink-50' : 'border-slate-200 bg-white hover:border-pink-100'} ${!isDisabled && difficulty === lvl.level ? 'ring-2 ring-pink-200' : ''}`}>
                                        <div className={`w-16 h-16 rounded-full flex-shrink-0 flex items-center justify-center border-2 shadow-sm bg-white overflow-hidden p-1`}>
                                            <img src={lvl.imgSrc} alt={lvl.charName} className="w-full h-full object-cover" />
                                        </div>
                                        <div>
                                            <div className={`font-bold text-sm flex items-center gap-2 ${difficulty === lvl.level && !isDisabled ? 'text-slate-800' : 'text-slate-600'}`}>
                                                {lvl.label}
                                                {difficulty === lvl.level && !isDisabled && <span className="text-xs bg-slate-800 text-white px-2 py-0.5 rounded-full shadow-sm animate-pulse">{lvl.slogan}</span>}
                                            </div>
                                            <div className="text-xs opacity-70">{lvl.desc}</div>
                                            {isDisabled && <div className="text-[10px] text-red-400 font-bold">{hintText}</div>}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    <button onClick={startGame} className="w-full py-3 rounded-2xl bg-gradient-to-r from-blue-400 to-pink-400 text-white font-black text-lg shadow-lg shadow-blue-200 transform hover:-translate-y-1 transition-transform flex items-center justify-center gap-2">
                        <Play size={20} />
                        é–‹å§‹å°å¼ˆ
                    </button>
                </div>
              </div>
            );
          }

          const opponentLevel = DIFFICULTY_LEVELS[difficulty - 1];

          // Render Game Screen - å›ºå®šä½ˆå±€ + æ²å‹•å„ªåŒ–
          return (
            <div className={`h-[100dvh] w-full ${THEME.bg} font-sans select-none flex flex-col overflow-hidden relative`}>
              <SpaceBackground />
              
              {/* é ‚éƒ¨å€åŸŸ (å›ºå®š) */}
              <div className="flex-none pt-4 px-4 pb-2 z-10 flex flex-col gap-2 items-center w-full max-w-md mx-auto">
                  <div className="flex w-full justify-between items-center">
                      <div className="w-8"></div>
                      <div className="flex flex-col items-center">
                         <div className="text-lg font-black text-slate-700 tracking-wider flex"><span className="text-blue-500">åœæ£‹</span><span className="text-pink-500">æ˜Ÿçƒ</span></div>
                         <div className="text-[10px] font-bold text-pink-400 bg-pink-100 px-2 rounded-full flex items-center gap-1">
                            <span className="w-3 h-3 inline-block rounded-full overflow-hidden">
                                <img src={opponentLevel.imgSrc} alt="" className="w-full h-full object-cover" />
                            </span>
                            {boardSize}è·¯ VS Lv.{difficulty}
                         </div>
                      </div>
                      <div className="w-8"></div>
                  </div>

                  <div className="flex justify-between items-center w-full gap-2">
                    <PlayerCard player="p1" isActive={turn === 'p1'} prisoners={prisoners.p1} isAi={playerColor === 'p2'} thinking={turn === 'p1' && isAiThinking} score={finalScore?.black} />
                    <div className="text-xl font-black text-slate-300">VS</div>
                    <PlayerCard player="p2" isActive={turn === 'p2'} prisoners={prisoners.p2} isAi={playerColor === 'p1'} thinking={turn === 'p2' && isAiThinking} score={finalScore?.white} />
                  </div>

                  <div className="h-6 flex items-center justify-center w-full">
                    {gameStatus === 'ended' ? (
                         <div className="text-sm font-bold text-white bg-gradient-to-r from-blue-400 to-pink-400 px-4 py-1 rounded-full shadow-md">
                            {finalScore.black > finalScore.white ? 'é»‘æ£‹ç²å‹ï¼' : 'ç™½æ£‹ç²å‹ï¼'}
                         </div>
                    ) : isAiThinking ? (
                         <div className="flex items-center gap-2 text-slate-500 text-xs font-bold bg-white/60 px-4 py-1 rounded-full animate-pulse">
                            <Brain size={12} /> AI æ€è€ƒä¸­...
                         </div>
                    ) : (
                      <div className="bg-white/90 px-4 py-1 rounded-full shadow-sm text-slate-600 text-xs font-bold border border-slate-100 truncate max-w-full">
                        {message || 'è¼ªåˆ°ä½ äº†'}
                      </div>
                    )}
                  </div>
              </div>

              {/* ä¸­é–“æ²å‹•å€åŸŸï¼šåŒ…å«æ£‹ç›¤ + ä¸‹æ–¹æŒ‰éˆ• */}
              <div className="flex-1 w-full overflow-hidden relative z-10 flex flex-col">
                 <div className="w-full h-full overflow-auto flex flex-col items-center scrollbar-hide pb-4">
                    {/* æ£‹ç›¤ */}
                    <div className="flex-none p-4 flex justify-center">
                        <div 
                          className={`bg-[#f8e8c8] relative rounded-lg shadow-[0_10px_20px_rgba(0,0,0,0.15)] border-2 ${THEME.boardBorder} flex-shrink-0`} 
                          style={{ 
                             display: 'grid', 
                             gridTemplateColumns: `repeat(${boardSize}, 1fr)`, 
                             ...getBoardSizeStyle(boardSize),
                             padding: '4%' 
                          }}
                        >
                          <GridLines size={boardSize} />
                          <StarPoints size={boardSize} />
                          
                          {board.map((row, y) => (
                            row.map((color, x) => (
                              <div
                                key={`${x}-${y}`}
                                onClick={() => handlePlayerMove(x, y)}
                                className={`relative z-10 flex items-center justify-center rounded-full transition-all duration-200
                                   ${gameStatus === 'playing' && !color && !isAiThinking && turn === playerColor ? 'cursor-pointer' : ''}
                                `}
                              >
                                {color && (
                                  <div className={`
                                    w-[95%] h-[95%] rounded-full 
                                    transition-all duration-300 transform scale-100
                                    ${THEME[color].stoneStyle}
                                    ${lastMove?.x === x && lastMove?.y === y && gameStatus === 'playing' ? 'ring-2 ring-yellow-400 ring-offset-1 scale-105' : ''}
                                  `}></div>
                                )}
                                
                                {gameStatus === 'playing' && !color && turn === playerColor && !isAiThinking && (
                                  <div className={`w-[85%] h-[85%] rounded-full opacity-0 hover:opacity-40 ${playerColor === 'p1' ? 'bg-black' : 'bg-white'}`}></div>
                                )}
                              </div>
                            ))
                          ))}
                        </div>
                    </div>

                    {/* æŒ‰éˆ•å€åŸŸï¼šç¾åœ¨ä½æ–¼æ²å‹•å®¹å™¨å…§ï¼Œç¢ºä¿ä¸€å®šæ»‘å¾—åˆ° */}
                    {gameStatus === 'playing' && (
                      <div className="flex-none w-full max-w-md px-4 pb-24 pt-2 flex gap-2 justify-center">
                        <ActionButton onClick={onLeaveRequest} label="é›¢é–‹" color="bg-yellow-400 hover:bg-yellow-500 text-white border-b-4 border-yellow-600 flex-[0.6]" />
                        <ActionButton onClick={handleManualEndGame} label="ç®—å‹è² " disabled={!hasMoves} color="bg-pink-400 hover:bg-pink-500 text-white border-b-4 border-pink-600 flex-1" />
                        <ActionButton onClick={onRestartRequest} label="é‡æ–°é–‹å§‹" color="bg-sky-400 hover:bg-sky-500 text-white border-b-4 border-sky-600 flex-1" />
                      </div>
                    )}
                 </div>
                 
                 {showConfetti && <CaptureEffect />}
              </div>

              {/* å½ˆå‡ºè¦–çª—å±¤ */}
              {gameStatus === 'ended' && (
                 <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/30 backdrop-blur-[2px] p-4"> {/* é€™è£¡åŠ å…¥äº† p-4 */}
                     <div className="relative bg-white p-6 rounded-3xl shadow-2xl transform animate-bounce-short text-center w-full max-w-sm border-4 border-pink-200"> {/* é€™è£¡ä¿®æ­£äº†å¯¬åº¦ç‚º max-w-sm */}
                         <WinEffect />
                         
                         <div className="relative z-10">
                            <h2 className="text-3xl font-black text-slate-700 mb-6 tracking-widest">
                                {finalScore.black > finalScore.white ? 'é»‘æ£‹ è´' : 'ç™½æ£‹ è´'}
                            </h2>
                            <div className="flex justify-center items-end gap-2 mb-8">
                                <div className={`flex flex-col items-center transition-all duration-500 ${finalScore.black > finalScore.white ? 'scale-110 z-10' : 'scale-90 opacity-60 grayscale-[0.5]'}`}>
                                    {finalScore.black > finalScore.white && <div className="text-2xl mb-1 animate-bounce">ğŸ‘‘</div>}
                                    <div className={`p-3 rounded-2xl border-4 min-w-[90px] ${finalScore.black > finalScore.white ? 'bg-slate-800 border-yellow-400 shadow-lg' : 'bg-slate-100 border-slate-200'}`}>
                                        <div className={`text-sm font-bold mb-1 ${finalScore.black > finalScore.white ? 'text-yellow-400' : 'text-slate-500'}`}>é»‘æ£‹</div>
                                        <div className={`text-4xl font-black ${finalScore.black > finalScore.white ? 'text-white' : 'text-slate-700'}`}>{finalScore.black}</div>
                                    </div>
                                    {finalScore.black > finalScore.white && <div className="text-xs font-black text-yellow-500 mt-2 bg-yellow-100 px-2 py-0.5 rounded-full">ç²å‹!</div>}
                                </div>
                                <div className="text-slate-300 font-black text-xl pb-8">VS</div>
                                <div className={`flex flex-col items-center transition-all duration-500 ${finalScore.white > finalScore.black ? 'scale-110 z-10' : 'scale-90 opacity-60 grayscale-[0.5]'}`}>
                                    {finalScore.white > finalScore.black && <div className="text-2xl mb-1 animate-bounce">ğŸ‘‘</div>}
                                    <div className={`p-3 rounded-2xl border-4 min-w-[90px] ${finalScore.white > finalScore.black ? 'bg-white border-yellow-400 shadow-lg' : 'bg-slate-100 border-slate-200'}`}>
                                        <div className="text-sm font-bold mb-1 text-slate-500">ç™½æ£‹</div>
                                        <div className={`text-4xl font-black ${finalScore.white > finalScore.black ? 'text-pink-500' : 'text-slate-700'}`}>{finalScore.white}</div>
                                    </div>
                                    {finalScore.white > finalScore.black && <div className="text-xs font-black text-pink-500 mt-2 bg-pink-100 px-2 py-0.5 rounded-full">ç²å‹!</div>}
                                </div>
                            </div>
                            <button onClick={startGame} className="w-full py-4 bg-gradient-to-r from-pink-400 to-orange-400 text-white rounded-2xl font-black text-lg shadow-lg hover:from-pink-500 hover:to-orange-500 transition-all active:scale-95 active:shadow-none">
                                å†ç©ä¸€å±€
                            </button>
                         </div>
                     </div>
                 </div>
              )}

              {confirmAction && (
                <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-[1px]">
                    <div className="bg-white p-6 rounded-3xl shadow-2xl max-w-xs w-full border-4 border-amber-200 animate-pop-in">
                        <div className="flex justify-center mb-3 text-amber-400"><AlertTriangle size={48} /></div>
                        <h3 className="text-xl font-black text-slate-700 text-center mb-2">{confirmAction.title}</h3>
                        <p className="text-sm text-slate-500 text-center mb-6">{confirmAction.desc}</p>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600 hover:bg-slate-200">å–æ¶ˆ</button>
                            <button onClick={onConfirm} className="flex-1 py-3 rounded-xl font-bold bg-amber-400 text-white hover:bg-amber-500 shadow-md">ç¢ºå®š</button>
                        </div>
                    </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
